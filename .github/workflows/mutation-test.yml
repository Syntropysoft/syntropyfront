name: Mutation Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Permite ejecuciÃ³n manual

jobs:
  mutation-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
        
    - name: Setup Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'pnpm'
        
    - name: Install dependencies
      run: pnpm install
      
    - name: Run tests first
      run: pnpm test
      
    - name: Run mutation testing
      run: pnpm run test:mutation:quick
      env:
        # ConfiguraciÃ³n para Stryker
        STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}
        
    - name: Upload mutation report
      uses: actions/upload-artifact@v4
      with:
        name: mutation-report-${{ github.run_number }}
        path: reports/mutation/
        retention-days: 90
        
    - name: Extract mutation score
      id: mutation-score
      run: |
        if [ -f "reports/mutation/mutation.html" ]; then
          # Extraer el score usando grep y sed
          SCORE=$(grep -o 'Mutation score.*[0-9]\+\.[0-9]*%' reports/mutation/mutation.html | grep -o '[0-9]\+\.[0-9]*' | head -1)
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "Mutation Score: $SCORE%"
        else
          echo "score=0" >> $GITHUB_OUTPUT
          echo "No mutation report found"
        fi
        
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const score = '${{ steps.mutation-score.outputs.score }}';
          const runId = '${{ github.run_id }}';
          const repo = '${{ github.repository }}';
          
          let status = 'âœ…';
          let message = 'Excellent!';
          
          if (score < 70) {
            status = 'âš ï¸';
            message = 'Needs improvement';
          } else if (score < 80) {
            status = 'ğŸŸ¡';
            message = 'Good';
          } else if (score >= 90) {
            status = 'ğŸ†';
            message = 'Outstanding!';
          }
          
          const comment = `## ${status} Mutation Testing Results
          
          **Score: ${score}%** - ${message}
          
          ğŸ“Š [View detailed report](https://github.com/${repo}/actions/runs/${runId})
          ğŸ“ [Download artifacts](https://github.com/${repo}/actions/runs/${runId}/artifacts)
          
          ---
          *Generated by GitHub Actions*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: Create issue for low mutation score
      if: github.event_name == 'pull_request' && steps.mutation-score.outputs.score < '70'
      uses: actions/github-script@v7
      with:
        script: |
          const score = '${{ steps.mutation-score.outputs.score }}';
          const prNumber = context.issue.number;
          const prUrl = context.issue.html_url;
          
          const issueBody = `## ğŸš¨ Low Mutation Score Detected
          
          **Current Score: ${score}%**
          
          This PR has a mutation score below the recommended threshold of 70%.
          
          ### ğŸ“‹ Action Items:
          - [ ] Review surviving mutants in the mutation report
          - [ ] Add missing test cases
          - [ ] Improve test assertions
          - [ ] Consider edge cases
          
          ### ğŸ”— Related PR:
          ${prUrl}
          
          ---
          *Auto-generated by GitHub Actions*`;
          
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Low Mutation Score: ${score}% (PR #${prNumber})`,
            body: issueBody,
            labels: ['mutation-testing', 'quality', 'needs-attention']
          }); 